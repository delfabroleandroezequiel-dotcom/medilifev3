@model IEnumerable<MedilifeSaludV3.Web.Models.Presupuesto>

@{
    ViewData["Title"] = "Presupuestos";
    var q = (ViewBag.Q as string) ?? "";
}

<div class="container-fluid mt-4">

    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <h2 class="mb-0">Presupuestos</h2>

        <div class="d-flex align-items-center gap-2">
            <a class="btn btn-primary" asp-action="Create">
                <i class="bi bi-plus-lg"></i> Nuevo
            </a>

            <a class="btn btn-outline-success"
               asp-action="ExportExcel"
               asp-route-q="@q">
                <i class="bi bi-file-earmark-excel"></i> Todo
            </a>

            <button id="btnExportFiltrado" type="button" class="btn btn-outline-success">
                <i class="bi bi-file-earmark-excel"></i> Filtrado
            </button>

            <button id="btnToggleMore" type="button" class="btn btn-outline-secondary">
                <i class="bi bi-eye"></i> Más datos
            </button>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">

                <table id="tblPresupuestos" class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>N°</th>
                            <th>Fecha</th>
                            <th>Empresa</th>

                            <th class="text-center" style="width: 70px;">Ítems</th>

                            <th class="col-more">Prestador</th>
                            <th class="col-more">Institución</th>
                            <th class="col-more">Paciente</th>
                            <th class="col-more">Médico</th>

                            <!-- Auditoría -->
                            <th class="col-audit">Creado</th>
                            <th class="col-audit">Modificado</th>

                            <th class="text-end" style="width: 240px;"></th>
                        </tr>

                        <!-- Filtros por columna (2da fila) -->
                        <tr>
                            <th>
                                <input id="fNumero" class="form-control form-control-sm dt-col-filter" data-col="0" placeholder="Filtrar..." />
                            </th>

                            <th>
                                <div class="d-flex gap-1">
                                    <input id="fechaDesde" type="date" class="form-control form-control-sm" title="Fecha desde" />
                                    <input id="fechaHasta" type="date" class="form-control form-control-sm" title="Fecha hasta" />
                                </div>
                            </th>

                            <th>
                                <input id="fEmpresa" class="form-control form-control-sm dt-col-filter" data-col="2" placeholder="Filtrar..." />
                            </th>

                            <th></th>

                            <th class="col-more">
                                <input id="fPrestador" class="form-control form-control-sm dt-col-filter" data-col="4" placeholder="Filtrar..." />
                            </th>
                            <th class="col-more">
                                <input id="fInstitucion" class="form-control form-control-sm dt-col-filter" data-col="5" placeholder="Filtrar..." />
                            </th>
                            <th class="col-more">
                                <input id="fPaciente" class="form-control form-control-sm dt-col-filter" data-col="6" placeholder="Filtrar..." />
                            </th>
                            <th class="col-more">
                                <input id="fMedico" class="form-control form-control-sm dt-col-filter" data-col="7" placeholder="Filtrar..." />
                            </th>

                            <!-- Auditoría fecha desde/hasta -->
                            <th class="col-audit">
                                <div class="d-flex gap-1">
                                    <input id="creadoDesde" type="date" class="form-control form-control-sm" title="Creado desde" />
                                    <input id="creadoHasta" type="date" class="form-control form-control-sm" title="Creado hasta" />
                                </div>
                            </th>
                            <th class="col-audit">
                                <div class="d-flex gap-1">
                                    <input id="modDesde" type="date" class="form-control form-control-sm" title="Modificado desde" />
                                    <input id="modHasta" type="date" class="form-control form-control-sm" title="Modificado hasta" />
                                </div>
                            </th>

                            <th></th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var p in Model)
                        {
                            var empresaTxt = (p.Empresa?.RazonSocial ?? p.Empresa?.NombreEmpresa ?? "-");
                            var prestadorTxt = (p.Prestador?.Nombre ?? "-");
                            var institucionTxt = (p.Institucion?.Nombre ?? "-");
                            var pacienteTxt = (p.Paciente != null ? (p.Paciente.Apellido + ", " + p.Paciente.Nombre) : "-");
                            var medicoTxt = (p.Medico != null ? (p.Medico.Apellido + ", " + p.Medico.Nombre) : "-");

                            <tr>
                                <td>@p.Numero</td>

                                <td data-fecha="@p.Fecha.ToString("yyyy-MM-dd")">
                                    @p.Fecha.ToString("dd/MM/yyyy")
                                </td>

                                <td>@empresaTxt</td>

                                <td class="text-center">
                                    <button type="button"
                                            class="btn btn-sm btn-outline-secondary btn-items"
                                            data-id="@p.Id"
                                            title="Ver ítems">
                                        <i class="bi bi-list-ul"></i>
                                    </button>
                                </td>

                                <td class="col-more">@prestadorTxt</td>
                                <td class="col-more">@institucionTxt</td>
                                <td class="col-more">@pacienteTxt</td>
                                <td class="col-more">@medicoTxt</td>

                                <td class="col-audit" data-creado="@(p.Creado != default ? p.Creado.ToString("yyyy-MM-dd") : "")">
                                    <small class="text-muted">
                                        @(p.Creado != default ? p.Creado.ToString("dd/MM/yyyy HH:mm") : "")<br />
                                        @p.CreadoPor
                                    </small>
                                </td>

                                <td class="col-audit" data-modificado="@(p.Modificado != default ? p.Modificado.Value.ToString("yyyy-MM-dd") : "")">
                                    <small class="text-muted">
                                        @(p.Modificado != default ? p.Modificado.Value.ToString("dd/MM/yyyy HH:mm") : "")<br />
                                        @p.ModificadoPor
                                    </small>
                                </td>

                                <td class="text-end">
                                    <a class="btn btn-sm btn-outline-secondary" asp-action="Details" asp-route-id="@p.Id" title="Ver">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a class="btn btn-sm btn-outline-primary" asp-action="Edit" asp-route-id="@p.Id" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <a class="btn btn-sm btn-outline-secondary" asp-action="Print" asp-route-id="@p.Id" target="_blank" title="Print">
                                        <i class="bi bi-printer"></i>
                                    </a>
                                    <a class="btn btn-sm btn-outline-danger" asp-action="Delete" asp-route-id="@p.Id" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>

                </table>

            </div>
        </div>
    </div>

</div>

<!-- Modal Items -->
<div class="modal fade" id="itemsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ítems del presupuesto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body" id="itemsModalBody">
                <div class="text-center py-4">
                    <div class="spinner-border" role="status"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {

            // Rango fechas (Fecha del presupuesto) + rango fechas auditoría (data-creado / data-modificado)
            $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                if (settings.nTable.id !== 'tblPresupuestos') return true;

                var row = settings.aoData[dataIndex].nTr;

                // Fecha presupuesto
                var fecha = $(row).find('td').eq(1).attr('data-fecha') || "";
                var fechaDesde = $('#fechaDesde').val();
                var fechaHasta = $('#fechaHasta').val();
                if (fechaDesde && (!fecha || fecha < fechaDesde)) return false;
                if (fechaHasta && (!fecha || fecha > fechaHasta)) return false;

                // Auditoría: Creado
                var creado = $(row).find('td.col-audit').eq(0).attr('data-creado') || "";
                var creadoDesde = $('#creadoDesde').val();
                var creadoHasta = $('#creadoHasta').val();
                if (creadoDesde && (!creado || creado < creadoDesde)) return false;
                if (creadoHasta && (!creado || creado > creadoHasta)) return false;

                // Auditoría: Modificado
                var mod = $(row).find('td.col-audit').eq(1).attr('data-modificado') || "";
                var modDesde = $('#modDesde').val();
                var modHasta = $('#modHasta').val();
                if ((modDesde || modHasta) && !mod) return false;
                if (modDesde && mod < modDesde) return false;
                if (modHasta && mod > modHasta) return false;

                return true;
            });

            var table = $('#tblPresupuestos').DataTable({
                orderCellsTop: true,
                fixedHeader: false,
                pageLength: 25,
                lengthChange: true,
                searching: true,
                dom: "<'row mb-2'<'col-12'tr>>" +
                     "<'row mt-2'<'col-md-5'i><'col-md-7'p>>",
                ordering: true,
                info: true,
                autoWidth: false,
                columnDefs: [
                    { orderable: false, targets: [3, 10] }, // items + acciones
                    { searchable: false, targets: [3, 10] },
                    { visible: false, targets: [4,5,6,7,8,9] } // Más datos + Auditoría ocultos al inicio
                ],
                language: {
                    url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json"
                }
            });

            // filtros por columna (inputs)
            $('#tblPresupuestos thead tr:eq(1) .dt-col-filter').each(function () {
                var el = $(this);
                var colIndex = parseInt(el.data('col'));

                el.on('keyup change clear', function () {
                    table.column(colIndex).search(this.value || "").draw();
                });
            });

            // filtros fecha
            $('#fechaDesde,#fechaHasta,#creadoDesde,#creadoHasta,#modDesde,#modHasta').on('change', function () {
                table.draw();
            });

            // toggle Más datos (Prestador/Institución/Paciente/Médico + Auditoría)
            var moreVisible = false;
            $('#btnToggleMore').on('click', function () {
                moreVisible = !moreVisible;

                // col indexes según el orden del table:
                // 0 N°, 1 Fecha, 2 Empresa, 3 Ítems, 4 Prestador, 5 Institución, 6 Paciente, 7 Médico, 8 Creado, 9 Modificado, 10 Acciones
                table.column(4).visible(moreVisible);
                table.column(5).visible(moreVisible);
                table.column(6).visible(moreVisible);
                table.column(7).visible(moreVisible);
                table.column(8).visible(moreVisible);
                table.column(9).visible(moreVisible);

                $(this).html(moreVisible
                    ? '<i class="bi bi-eye-slash"></i> Ocultar datos'
                    : '<i class="bi bi-eye"></i> Más datos'
                );
            });

            // modal items
            $(document).on('click', '.btn-items', function () {
                var id = $(this).data('id');
                var modalEl = document.getElementById('itemsModal');
                var modal = bootstrap.Modal.getOrCreateInstance(modalEl);

                $('#itemsModalBody').html('<div class="text-center py-4"><div class="spinner-border" role="status"></div></div>');
                modal.show();

                $.get('@Url.Action("ItemsModal", "Presupuesto")', { id: id })
                    .done(function (html) { $('#itemsModalBody').html(html); })
                    .fail(function () { $('#itemsModalBody').html('<div class="alert alert-danger mb-0">No se pudieron cargar los ítems.</div>'); });
            });

            // export filtrado (misma idea que ObraSocial: leemos filtros del header)
            $('#btnExportFiltrado').on('click', function () {
                var numero = $('#fNumero').val() || "";
                var empresa = $('#fEmpresa').val() || "";
                var prestador = $('#fPrestador').val() || "";
                var institucion = $('#fInstitucion').val() || "";
                var paciente = $('#fPaciente').val() || "";
                var medico = $('#fMedico').val() || "";

                var fechaDesde = $('#fechaDesde').val() || "";
                var fechaHasta = $('#fechaHasta').val() || "";

                var creadoDesde = $('#creadoDesde').val() || "";
                var creadoHasta = $('#creadoHasta').val() || "";
                var modDesde = $('#modDesde').val() || "";
                var modHasta = $('#modHasta').val() || "";

                var qs = new URLSearchParams({
                    q: '@q',
                    numero, empresa, prestador, institucion, paciente, medico,
                    fechaDesde, fechaHasta,
                    creadoDesde, creadoHasta, modDesde, modHasta
                });

                window.location.href = '@Url.Action("ExportExcelFiltered", "Presupuesto")' + '?' + qs.toString();
            });

        });
    </script>
}